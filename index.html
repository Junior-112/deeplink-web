<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MCash Wallet Deep Link Tester</title>
</head>
<body>
  <script>
    let history = [];

    // ============================================
    // Deep Link Handler Class
    // ============================================
    class DeepLinkHandler {
      constructor(options = {}) {
        this.timeout = options.timeout || 2500;
        this.debug = options.debug || false;
      }

      log(message, data = {}) {
        if (this.debug) {
          console.log(`[DeepLink] ${message}`, data);
        }
      }

      async open(url) {
        this.log('Attempting to open', { url });

        return new Promise((resolve, reject) => {
          let appOpened = false;
          const startTime = Date.now();

          // Create hidden iframe for more reliable detection
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.style.width = '0';
          iframe.style.height = '0';

          const cleanup = () => {
            if (iframe.parentNode) {
              iframe.parentNode.removeChild(iframe);
            }
            window.removeEventListener('blur', onBlur);
            window.removeEventListener('pagehide', onPageHide);
            document.removeEventListener('visibilitychange', onVisibilityChange);
          };

          const onBlur = () => {
            if (!appOpened) {
              appOpened = true;
              const timeElapsed = Date.now() - startTime;
              this.log('App opened via blur', { timeElapsed });
              cleanup();
              resolve({ 
                success: true, 
                method: 'blur',
                timeElapsed 
              });
            }
          };

          const onPageHide = () => {
            if (!appOpened) {
              appOpened = true;
              const timeElapsed = Date.now() - startTime;
              this.log('App opened via pagehide', { timeElapsed });
              cleanup();
              resolve({ 
                success: true, 
                method: 'pagehide',
                timeElapsed 
              });
            }
          };

          const onVisibilityChange = () => {
            if (document.hidden && !appOpened) {
              appOpened = true;
              const timeElapsed = Date.now() - startTime;
              this.log('App opened via visibility', { timeElapsed });
              cleanup();
              resolve({ 
                success: true, 
                method: 'visibility',
                timeElapsed 
              });
            }
          };

          // Add listeners
          window.addEventListener('blur', onBlur);
          window.addEventListener('pagehide', onPageHide);
          document.addEventListener('visibilitychange', onVisibilityChange);

          // Try to open via iframe first
          document.body.appendChild(iframe);
          iframe.src = url;

          // Fallback to direct navigation
          setTimeout(() => {
            if (!appOpened) {
              window.location.href = url;
            }
          }, 500);

          // Final timeout check
          setTimeout(() => {
            cleanup();
            
            if (!appOpened) {
              const timeElapsed = Date.now() - startTime;
              this.log('App not detected', { timeElapsed });
                window.location.href=""
                const androidUrl = 'https://play.google.com/store/apps/details?id=com.mlhuillier.mlwallet&hl=en';

                const iosUrl = 'https://apps.apple.com/ph/app/mcash-wallet/id962204987';
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                console.log("USER AGENt",userAgent)
                if (/android/i.test(userAgent)) {
                  window.location.href = androidUrl;
                } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                  window.location.href = iosUrl;
                } else {
                  // Fallback for other platforms
                  window.location.href = androidUrl; // or any other page
                }
              reject({
                success: false,
                error: 'App not found or not installed',
                timeElapsed
              });
            }
          }, this.timeout);
        });
      }
    }

    // Initialize handler
    const deepLinkHandler = new DeepLinkHandler({
      timeout: 2500,
      debug: true
    });

    // ============================================
    // Open Deep Link Function
    // ============================================
    async function openDeepLink(url) {
    
      try {
        const response = await deepLinkHandler.open(url);
        console.log('Deep link response:', response);

      } catch (error) {
            const androidUrl = 'https://play.google.com/store/apps/details?id=com.mlhuillier.mlwallet&hl=en';

            const iosUrl = 'https://apps.apple.com/ph/app/mcash-wallet/id962204987';
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            console.log("USER AGENt",userAgent)
                if (/android/i.test(userAgent)) {
                  window.location.href = androidUrl;
                } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                  window.location.href = iosUrl;
                } else {
                  // Fallback for other platforms
                  window.location.href = androidUrl; // or any other page
          }
      }
    }



    // Initialize
    openDeepLink('mlwallet://');
  </script>
</body>
</html>